cmake_minimum_required(VERSION 3.27)
project(GooCompiler)

set(CMAKE_CXX_STANDARD 26)
set(CMAKE_CXX_STANDARD_REQUIRED ON)

# === Directories ===
set(COMPILER_TARGET_DIR "Compiler")
set(BINARY_TARGET_DIR "Bin")
set(RUNTIME_TARGET_DIR "Runtime")

file(MAKE_DIRECTORY ${CMAKE_BINARY_DIR}/${BINARY_TARGET_DIR})

# === LLVM Setup ===
find_package(LLVM REQUIRED CONFIG)
message(STATUS "ğŸ§  LLVM ${LLVM_PACKAGE_VERSION} Found in: ${LLVM_DIR}")
message(STATUS "ğŸ”§ LLVM Lib Dir: ${LLVM_LIBRARY_DIRS}")

include_directories(${LLVM_INCLUDE_DIRS})
add_definitions(${LLVM_DEFINITIONS})

# === Sources ===
set(COMPILER_SRC "${COMPILER_TARGET_DIR}/goo.cpp")
set(COMPILER_SRC_JIT "${COMPILER_TARGET_DIR}/llvm-test-jit.cpp")
set(RUNTIME_SRC "${RUNTIME_TARGET_DIR}/Runtime.cpp")
set(ENTRY_FILE "Entry.cpp")

# === Shared Runtime Library ===
add_library(goostdm SHARED ${RUNTIME_SRC})
set_target_properties(goostdm PROPERTIES
    LIBRARY_OUTPUT_DIRECTORY ${CMAKE_BINARY_DIR}/${RUNTIME_TARGET_DIR}
    OUTPUT_NAME "goostdm"
)

# === Compiler ===
add_executable(goo ${COMPILER_SRC})
target_link_libraries(goo PRIVATE LLVM-19)
set_target_properties(goo PROPERTIES
    RUNTIME_OUTPUT_DIRECTORY ${CMAKE_BINARY_DIR}/${BINARY_TARGET_DIR}
)

# === Custom Targets ===
add_custom_target(compiler DEPENDS goo)
add_custom_target(compiler-jit DEPENDS goo-jit)
add_custom_target(runtime DEPENDS goostdm)

# === Color Macros ===
string(ASCII 27 Esc)
set(RESET "${Esc}[0m")
set(BOLD "${Esc}[1m")
set(GREEN "${Esc}[32m")
set(CYAN  "${Esc}[36m")
set(PINK  "${Esc}[35m")
set(YELLOW "${Esc}[33m")

# === GooCompiler Build Summary ===
message(NOTICE "\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”  ${PINK}${BOLD}${PROJECT_NAME} Build Summary${RESET}  â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n")

message(STATUS "â”Œâ”€ ğŸ› ï¸  Build Configuration â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€")
message(STATUS "â”‚ Operating System        : ${CMAKE_SYSTEM_NAME}")
message(STATUS "â”‚ CMake Version           : ${CMAKE_VERSION}")
message(STATUS "â”‚ Compiler                : ${CMAKE_CXX_COMPILER} ${CMAKE_CXX_COMPILER_VERSION}")
message(STATUS "â”‚ C++ Standard            : C++${CMAKE_CXX_STANDARD}")
message(STATUS "â”‚ Build Type              : ${CMAKE_BUILD_TYPE}")
message(STATUS "â”‚ Build System            : ${CMAKE_MAKE_PROGRAM}")
message(STATUS "â”‚ Linker                  : ${CMAKE_LINKER}")
message(STATUS "â”‚ Compiler Flags          : ${CMAKE_CXX_FLAGS}")
message(STATUS "â”‚ Linker Flags            : ${CMAKE_EXE_LINKER_FLAGS}")
message(STATUS "â”‚ LLVM Version            : ${LLVM_PACKAGE_VERSION}")
message(STATUS "â”‚ LLVM Link Mode          : -lLLVM-19")

message(STATUS "â”œâ”€ ğŸ“‚ Output Locations â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€")
message(STATUS "â”‚ Binaries Output Dir     : ${CMAKE_BINARY_DIR}/${BINARY_TARGET_DIR}")
message(STATUS "â”‚ Runtime Library Dir     : ${CMAKE_BINARY_DIR}/${RUNTIME_TARGET_DIR}")
message(STATUS "â”‚ Final Shared Library    : ${CMAKE_BINARY_DIR}/${RUNTIME_TARGET_DIR}/libgoostdm.so")

message(STATUS "â”œâ”€ ğŸš€ Built Targets â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€")
message(STATUS "â”‚ Compiler (Static)       : ${BINARY_TARGET_DIR}/goo")
message(STATUS "â””â”€  Runtime (Shared lib)  : ${RUNTIME_TARGET_DIR}/libgoostdm.so")
message(NOTICE "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n")

# === Final All Target ===
add_custom_target(everything
  DEPENDS goo goostdm summary
)
